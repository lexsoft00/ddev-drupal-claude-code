name: drupal-claude-code

ddev_version_constraint: '>= v1.24.3'

project_files:
  - commands/web/claude
  - commands/web/glab
  - config.drupal-claude-code.yaml
  - drupal-claude-code/.gitignore
  - drupal-claude-code/.claudeignore
  - drupal-claude-code/settings.json
  - drupal-claude-code/settings.local.json
  - drupal-claude-code/statusline.sh
  - drupal-claude-code/templates/CLAUDE.md.template
  - drupal-claude-code/serena/project.yml
  - drupal-claude-code/serena/memories/project-overview.md
  - drupal-claude-code/serena/memories/task-completion-checklist.md
  - drupal-claude-code/serena/memories/architecture-patterns.md
  - drupal-claude-code/serena/memories/code-style-conventions.md
  - drupal-claude-code/serena/memories/commands-reference.md
  - drupal-claude-code/serena/memories/security-guidelines.md
  - web-build/Dockerfile.drupal-claude-code
  - web-build/claude-code.gitignore

global_files: []

pre_install_actions:
  - |
    #ddev-description: Checking environment
    echo "Installing Drupal Claude Code addon..."

post_install_actions:
  - |
    #ddev-description: Creating project directories
    mkdir -p "$DDEV_APPROOT/.ddev/drupal-claude-code/templates"
    mkdir -p "$DDEV_APPROOT/.ddev/drupal-claude-code/serena/memories"
    mkdir -p "$DDEV_APPROOT/.ddev/.claude"
    chmod +x "$DDEV_APPROOT/.ddev/commands/web/claude" 2>/dev/null || true
    chmod +x "$DDEV_APPROOT/.ddev/commands/web/glab" 2>/dev/null || true
    chmod +x "$DDEV_APPROOT/.ddev/drupal-claude-code/statusline.sh" 2>/dev/null || true

  - |
    #ddev-description: Setting up project files
    if [ ! -f "$DDEV_APPROOT/CLAUDE.md" ] && [ -f "$DDEV_APPROOT/.ddev/drupal-claude-code/templates/CLAUDE.md.template" ]; then
      cp "$DDEV_APPROOT/.ddev/drupal-claude-code/templates/CLAUDE.md.template" "$DDEV_APPROOT/CLAUDE.md"
      echo "Created CLAUDE.md in project root."
    fi
    if [ ! -f "$DDEV_APPROOT/.claudeignore" ] && [ -f "$DDEV_APPROOT/.ddev/drupal-claude-code/.claudeignore" ]; then
      cp "$DDEV_APPROOT/.ddev/drupal-claude-code/.claudeignore" "$DDEV_APPROOT/.claudeignore"
      echo "Created .claudeignore in project root."
    fi

  - |
    #ddev-description: Setting up Serena configuration
    mkdir -p "$DDEV_APPROOT/.serena/memories"
    # Copy project.yml to .serena/ (only if not exists)
    if [ ! -f "$DDEV_APPROOT/.serena/project.yml" ] && [ -f "$DDEV_APPROOT/.ddev/drupal-claude-code/serena/project.yml" ]; then
      cp "$DDEV_APPROOT/.ddev/drupal-claude-code/serena/project.yml" "$DDEV_APPROOT/.serena/project.yml"
      # Replace placeholder with actual project name (cross-platform sed)
      if [[ "$OSTYPE" == "darwin"* ]]; then
        sed -i '' "s/drupal-project/$DDEV_PROJECT/g" "$DDEV_APPROOT/.serena/project.yml"
      else
        sed -i "s/drupal-project/$DDEV_PROJECT/g" "$DDEV_APPROOT/.serena/project.yml"
      fi
      echo "Created .serena/project.yml"
    fi
    # Copy memory files
    if [ -d "$DDEV_APPROOT/.ddev/drupal-claude-code/serena/memories" ]; then
      for f in "$DDEV_APPROOT/.ddev/drupal-claude-code/serena/memories"/*.md; do
        [ -f "$f" ] && [ ! -f "$DDEV_APPROOT/.serena/memories/$(basename $f)" ] && cp "$f" "$DDEV_APPROOT/.serena/memories/"
      done
      echo "Serena memories configured."
    fi

  - |
    #ddev-description: Installation complete
    echo ""
    echo "=============================================="
    echo "  Drupal Claude Code Addon Installed!"
    echo "=============================================="
    echo ""
    echo "Next steps:"
    echo "  1. ddev restart"
    echo "  2. ddev ssh"
    echo "  3. claude"
    echo ""

removal_actions:
  - |
    #ddev-description: Removing addon files
    echo "Removing Claude Code addon files..."
    rm -rf "$DDEV_APPROOT/.ddev/drupal-claude-code/"
    rm -rf "$DDEV_APPROOT/.ddev/.claude/"
    rm -f "$DDEV_APPROOT/.ddev/config.drupal-claude-code.yaml"
    rm -f "$DDEV_APPROOT/.ddev/commands/web/claude"
    rm -f "$DDEV_APPROOT/.ddev/commands/web/glab"
    rm -f "$DDEV_APPROOT/.ddev/web-build/Dockerfile.drupal-claude-code"
    rm -f "$DDEV_APPROOT/.ddev/web-build/claude-code.gitignore"
    echo "NOTE: CLAUDE.md and .serena/ in project root were preserved."
